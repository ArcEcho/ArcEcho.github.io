<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh_CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文可以看作是一个学习笔记，对Shader Reflection进行简单的介绍，并通过代码展示如何使用它来搭建简单的“Effect”框架。">
<meta name="keywords" content="Shader,HLSL,C++,Rendering,Effect">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Shader Reflection搭建简单的Effect框架">
<meta property="og:url" content="http://yoursite.com/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/index.html">
<meta property="og:site_name" content="每天进补一点点！">
<meta property="og:description" content="本文可以看作是一个学习笔记，对Shader Reflection进行简单的介绍，并通过代码展示如何使用它来搭建简单的“Effect”框架。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/Snipaste_2019-03-26_13-37-33.png">
<meta property="og:updated_time" content="2019-03-26T05:59:30.425Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Shader Reflection搭建简单的Effect框架">
<meta name="twitter:description" content="本文可以看作是一个学习笔记，对Shader Reflection进行简单的介绍，并通过代码展示如何使用它来搭建简单的“Effect”框架。">
<meta name="twitter:image" content="http://yoursite.com/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/Snipaste_2019-03-26_13-37-33.png">






  <link rel="canonical" href="http://yoursite.com/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>使用Shader Reflection搭建简单的Effect框架 | 每天进补一点点！</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">每天进补一点点！</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Beranda</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Arsip</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ArcEcho">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="每天进补一点点！">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">使用Shader Reflection搭建简单的Effect框架

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              

              
                
              

              <time title="Post created: 2019-03-26 09:46:30 / Updated at: 13:59:30" itemprop="dateCreated datePublished" datetime="2019-03-26T09:46:30+08:00">2019-03-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">Di</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文可以看作是一个学习笔记，对Shader Reflection进行简单的介绍，并通过代码展示如何使用它来搭建简单的“Effect”框架。</p>
<a id="more"></a>
<h1 id="Shader-Reflection"><a href="#Shader-Reflection" class="headerlink" title="Shader Reflection"></a>Shader Reflection</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><blockquote>
<p>官方文档中的介绍：<a href="https://docs.microsoft.com/en-us/windows/desktop/api/d3d11shader/nn-d3d11shader-id3d11shaderreflection" target="_blank" rel="noopener">ID3D11ShaderReflection Interface </a></p>
</blockquote>
<p>通过这一系列的API，我们可以很轻松的知道shader字节码中的结构，注意这里强调的是shader字节码，而非HLSL。因为<a href="https://en.wikipedia.org/wiki/Shader" target="_blank" rel="noopener"><code>In computer graphics, a shader is a type of computer program</code></a>,这其实就跟代码和编译后的二进制可执行文件的区别是一样的。遥想之前和别人争论UE4的材质编辑器是不是shader时，如果当时我能清晰的理解定义的话就能够说服他了。咳咳，扯的有点远了。简单点来讲就是，Shader Reflection提供了对我们写在HLSL代码中的Constant Buffer、Shader Resource、Sampler等信息的描述。</p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="创建Shader-Reflection-对象"><a href="#创建Shader-Reflection-对象" class="headerlink" title="创建Shader Reflection 对象"></a>创建Shader Reflection 对象</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ...</span></span><br><span class="line">RE_D3D_ThrowIfFailed(</span><br><span class="line">         device-&gt;CreateVertexShader(</span><br><span class="line">             in_shaderBufferBlob-&gt;GetBufferPointer(),</span><br><span class="line">             in_shaderBufferBlob-&gt;GetBufferSize(),</span><br><span class="line">             <span class="literal">NULL</span>,</span><br><span class="line">             m_shader.ReleaseAndGetAddressOf()</span><br><span class="line">         )</span><br><span class="line">     );</span><br><span class="line"></span><br><span class="line"> ComPtr&lt;ID3D11ShaderReflection&gt; shaderReflection;</span><br><span class="line">     RE_D3D_ThrowIfFailed(</span><br><span class="line">         D3DReflect(</span><br><span class="line">             in_shaderBufferBlob-&gt;GetBufferPointer(),</span><br><span class="line">             in_shaderBufferBlob-&gt;GetBufferSize(),</span><br><span class="line">             IID_PPV_ARGS(shaderReflection.ReleaseAndGetAddressOf())</span><br><span class="line">         )</span><br><span class="line">     );</span><br><span class="line"></span><br><span class="line"> HandleShaderRefelction(shaderReflection.Get());</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>创建方式非常直接明了，只需要shader字节码即可，即run time compiled还是pre compiled的都行。</p>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ID3D11ShaderReflectionConstantBuffer *shaderReflectionConstantBuffer = <span class="literal">nullptr</span>;;</span><br><span class="line">shaderReflectionConstantBuffer = in_shaderReflection-&gt;GetConstantBufferByIndex(constantBufferIndex);</span><br></pre></td></tr></table></figure>
<p>Shader Reflection中包含了多种类型的反射类型，比如 shaderReflectionConstantBuffer、ID3D11ShaderReflectionVariable等。我们需要做的就是去访问它提供的这些个对象，然后获取它们的描述然后记录下来，并填充我们C++中的对应shader的类就行了。</p>
<h2 id="学习动机"><a href="#学习动机" class="headerlink" title="学习动机"></a>学习动机</h2><p>学习Shader Reflection的主要原因是因为，之前直接照着教程使用FX框架，很容易就变成了抄代码，并没了解整个框架的具体流程。这其实这是学习任何框架、引擎等自成体系的东西的公有弊端。很容易把它们当成工具来学习，而忽略了它们的工作原理。而且这些东西的高度封装性也很容易让人不知道从何处开始剖析。所以我学着RasterTek的教程中，一个HLSL对应一个C++类来开始重新学习一些东西。但这太痛苦了，也就是说一处改动可能要修改两部分代码，并且还要保证它们完全一致。那么有没有什么好的方法，既能了解运作原理又能减轻编写负担呢。我寻找了一些资料，最终这个Shader Relection进入了我的视线，并学习构建了一个简单的Effect框架。</p>
<h1 id="自制“Effect”框架"><a href="#自制“Effect”框架" class="headerlink" title="自制“Effect”框架"></a>自制“Effect”框架</h1><p>根据前文中提到的，Shader Reflection提供了对shader内容的描述。所以通过这些信息我们完全可以在C++中动态构建一个类来做好相应数据之间的映射，从而避免每一个hlsl对应一个C++类。那么下面就介绍通常使用的几个类型把。</p>
<h2 id="常用的几个类型"><a href="#常用的几个类型" class="headerlink" title="常用的几个类型"></a>常用的几个类型</h2><p>一般来说我们在C++代码中需要关心的就是Constant Buffer、Shader Resource View的等，Shader Reflection识别出这些对象便可以记录到的C++类中。</p>
<h3 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h3><p>Variable类实际上就是Constant Buffer中的被使用的成员，注意这里我们所说的是被使用的。之所以这么说，是因为在HLSL代码在编译时会被优化，有些没有使用的变量是不会写入到shader中的。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VariableProxy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> ByteOffset;                 <span class="comment">// 在整个Constant Buffer中的字节偏移</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> SizeInBytes;                <span class="comment">// 字节大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> OwningConstantBufferIndex; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>unsigned int VariableProxy::OwningConstantBufferIndex</code><br>指的时拥有这个变量的Constant Buffer的索引，一般来说就是我们在写HLSL时，指定的寄存器的序号，如果没指定就是书写顺序。</li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">读取方式</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">ID3D11ShaderReflectionConstantBuffer *shaderReflectionConstantBuffer = <span class="literal">nullptr</span>;;</span><br><span class="line">shaderReflectionConstantBuffer = in_shaderReflection-&gt;GetConstantBufferByInde(constantBufferIndex）;</span><br><span class="line"></span><br><span class="line">D3D11_SHADER_BUFFER_DESC shaderBufferDesc;</span><br><span class="line">shaderReflectionConstantBuffer-&gt;GetDesc(&amp;shaderBufferDesc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (UINT variableIndex = <span class="number">0</span>; variableIndex &lt; shaderBufferDesc.Variables; ++variableIndex)</span><br><span class="line">&#123;</span><br><span class="line">    ID3D11ShaderReflectionVariable *shaderReflectionVariable =</span><br><span class="line">        shaderReflectionConstantBuffer-&gt;GetVariableByIndex(variableIndex);</span><br><span class="line"></span><br><span class="line">    D3D11_SHADER_VARIABLE_DESC shaderVariableDesc;</span><br><span class="line">    shaderReflectionVariable-&gt;GetDesc(&amp;shaderVariableDesc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> variableProxy = <span class="built_in">std</span>::make_shared&lt;VariableProxy&gt;();</span><br><span class="line">    variableProxy-&gt;OwningConstantBufferIndex = constantBufferIndex;</span><br><span class="line">    variableProxy-&gt;ByteOffset = shaderVariableDesc.StartOffset;</span><br><span class="line">    variableProxy-&gt;SizeInBytes = shaderVariableDesc.Size;</span><br><span class="line"></span><br><span class="line">    m_variableLookup.insert(<span class="built_in">std</span>::make_pair(shaderVariableDesc.Name, variableProxy));</span><br><span class="line">    constantBufferProxy-&gt;Variables.push_back(variableProxy);</span><br><span class="line">&#125;     </span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

</div></div>
<p>通过shaderReflection对象我们可以用Constant Buffer的索引，依次访问它拥有的所有变量，并记录下来。这个过程中我们最关心的就是定义中的那三个成员属性，并且之后我们可以使用名字或者索引来直接设置变量的值。比如:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> worldTransformMatrix = renderObject-&gt;GetTransform().GetTransformMatrix();</span><br><span class="line"><span class="keyword">auto</span> worldInverseMatrix = MathHelper::InverseWithoutTranslation(worldTransformMatrix);</span><br><span class="line">m_vertexShader-&gt;SetMatrix4x4(<span class="string">"worldMatrix"</span>, worldTransformMatrix);</span><br><span class="line">m_vertexShader-&gt;SetMatrix4x4(<span class="string">"viewMatrix"</span>, currentCamera.GetViewMatrix());</span><br><span class="line">m_vertexShader-&gt;SetMatrix4x4(<span class="string">"projectionMatrix"</span>, currentCamera.GetProjectionMatrix());</span><br><span class="line">m_vertexShader-&gt;SetMatrix4x4(<span class="string">"noTransflationWorldInvrseMatrix"</span>, worldInverseMatrix);</span><br></pre></td></tr></table></figure></p>
<p>这样就方便了很多，也和FX框架的使用方式比较靠近了。</p>
<h3 id="Constant-Buffer"><a href="#Constant-Buffer" class="headerlink" title="Constant Buffer"></a>Constant Buffer</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ConstantBufferProxy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> Index;                                     <span class="comment">// Constant Buffer的索引           </span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> Name;                                       <span class="comment">// HLSL定义Contant Buffer时使用的名字</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> SizeInBytes;                                </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  SlotIndex;</span><br><span class="line">    ComPtr&lt;ID3D11Buffer&gt; ConstantBuffer;                       </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>[]&gt; LocalDataBuffer;       </span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;VariableProxy&gt;&gt; Variables;</span><br><span class="line">    D3D_CBUFFER_TYPE Type;</span><br><span class="line">    <span class="keyword">bool</span> Dirty = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>ComPtr&lt;ID3D11Buffer&gt; ConstantBufferProxy::ConstantBuffer</code><br>  用来给GPU传数据的缓冲对象，为了方便每一个Proxy里面放一个。如果用<code>Map</code>方式的话，可以按大小和类型来只分配一个ID3D11Buffer供多个地方使用。</li>
<li><p><code>std::unique_ptr&lt;unsigned char[]&gt; ConstantBufferProxy::LocalDataBuffer</code><br>  每次写入数据实际上时先写到该变量对应的内存中，然后通过统一写到ID3D11Buffer中然后提交给GPU。</p>
</li>
<li><p><code>std::vector&lt;std::shared_ptr&lt;VariableProxy&gt;&gt; ConstantBufferProxy::Variables</code><br>  记录了这个Constant Buffer中真正用到的Variable。之所以是std::shared_ptr是因为在后面会建立一个Variable Name到其的查找表。</p>
</li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">读取方式</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">m_numConstantBuffers = shaderDesc.ConstantBuffers;</span><br><span class="line">m_constantBuffers.reserve(m_numConstantBuffers);</span><br><span class="line"><span class="keyword">for</span> (UINT constantBufferIndex = <span class="number">0</span>; constantBufferIndex &lt; m_numConstantBuffers; ++constantBufferIndex)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span> constantBufferProxy = <span class="built_in">std</span>::make_shared&lt;ConstantBufferProxy&gt;();</span><br><span class="line"></span><br><span class="line">    ID3D11ShaderReflectionConstantBuffer *shaderReflectionConstantBuffer = <span class="literal">nullptr</span>;;</span><br><span class="line">    shaderReflectionConstantBuffer = in_shaderReflection-&gt;GetConstantBufferByIndex(constantBufferIndex);</span><br><span class="line"></span><br><span class="line">    D3D11_SHADER_BUFFER_DESC shaderBufferDesc;</span><br><span class="line">    shaderReflectionConstantBuffer-&gt;GetDesc(&amp;shaderBufferDesc);</span><br><span class="line"></span><br><span class="line">    D3D11_SHADER_INPUT_BIND_DESC shaderInputBindDesc;</span><br><span class="line">    in_shaderReflection-&gt;GetResourceBindingDescByName(shaderBufferDesc.Name, &amp;shaderInputBindDesc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record data that we concerned.</span></span><br><span class="line">    constantBufferProxy-&gt;Index = constantBufferIndex;</span><br><span class="line">    constantBufferProxy-&gt;Name = shaderInputBindDesc.Name;</span><br><span class="line">    constantBufferProxy-&gt;SizeInBytes = shaderBufferDesc.Size;</span><br><span class="line">    constantBufferProxy-&gt;SlotIndex = shaderInputBindDesc.BindPoint;</span><br><span class="line">    constantBufferProxy-&gt;Type = shaderBufferDesc.Type;</span><br><span class="line"></span><br><span class="line">    D3D11_BUFFER_DESC newBuffDesc;</span><br><span class="line">    newBuffDesc.Usage = D3D11_USAGE_DYNAMIC;</span><br><span class="line">    newBuffDesc.ByteWidth = <span class="built_in">std</span>::max&lt;UINT&gt;(shaderBufferDesc.Size, <span class="number">16</span>);</span><br><span class="line">    newBuffDesc.BindFlags = D3D11_BIND_CONSTANT_BUFFER;</span><br><span class="line">    newBuffDesc.CPUAccessFlags = D3D11_CPU_ACCESS_WRITE;</span><br><span class="line">    newBuffDesc.MiscFlags = <span class="literal">NULL</span>;</span><br><span class="line">    newBuffDesc.StructureByteStride = <span class="number">0</span>;</span><br><span class="line">    RE_D3D_ThrowIfFailed(device-&gt;CreateBuffer(&amp;newBuffDesc, <span class="literal">NULL</span>, constantBufferProxy-&gt;ConstantBuffer.ReleaseAndGetAddressOf()));</span><br><span class="line"></span><br><span class="line">    constantBufferProxy-&gt;LocalDataBuffer = <span class="built_in">std</span>::make_unique&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>[]&gt;(newBuffDesc.ByteWidth);</span><br><span class="line">    ZeroMemory(constantBufferProxy-&gt;LocalDataBuffer.get(), newBuffDesc.ByteWidth);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... Variable Part.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Collect it to look up table.</span></span><br><span class="line">    m_constantBuffers.push_back(constantBufferProxy);</span><br><span class="line">    m_constantBufferLookup.insert(<span class="built_in">std</span>::make_pair(shaderInputBindDesc.Name, constantBufferProxy));;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

</div></div>
<p>代码有点长，但是其实也只是做了记录我们所需要的数据和申请资源的工作。</p>
<h3 id="Shader-Resource-View-和-Sampler"><a href="#Shader-Resource-View-和-Sampler" class="headerlink" title="Shader Resource View 和 Sampler"></a>Shader Resource View 和 Sampler</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ShaderResourceViewProxy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> Index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> SlotIndex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SamplerProxy</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> Index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> SlotIndex = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这两个一般都是成对出现的，需要注意的是诸如HLSL中的Texture2D、Texture3D等统一对应的是C++的ID3DShaderResourceView，以及SamplerState、SamplerComparisonState对应的是C++中的ID3D11SamplerState。即我们在C++中是可以统一它们。</p>
<div><div class="fold_hider"><div class="close hider_title">获取方式</div></div><div class="fold">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">D3D11_SHADER_DESC shaderDesc;</span><br><span class="line">RE_D3D_ThrowIfFailed(in_shaderReflection-&gt;GetDesc(&amp;shaderDesc));</span><br><span class="line"></span><br><span class="line">auto numBoundResources = shaderDesc.BoundResources;</span><br><span class="line">for (UINT resourceIndex = 0; resourceIndex &lt; numBoundResources; ++resourceIndex)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    D3D11_SHADER_INPUT_BIND_DESC shaderInputBindDesc;</span><br><span class="line">    in_shaderReflection-&gt;GetResourceBindingDesc(resourceIndex, &amp;shaderInputBindDesc);</span><br><span class="line"></span><br><span class="line">    switch (shaderInputBindDesc.Type)</span><br><span class="line">    &#123;</span><br><span class="line">    case D3D_SIT_TEXTURE:</span><br><span class="line">    &#123;</span><br><span class="line">        auto shaderResourceViewProxy = std::make_shared&lt;ShaderResourceViewProxy&gt;();</span><br><span class="line">        shaderResourceViewProxy-&gt;SlotIndex = shaderInputBindDesc.BindPoint;</span><br><span class="line">        shaderResourceViewProxy-&gt;Index = static_cast&lt;unsigned int&gt;(m_shaderResourceViews.size());</span><br><span class="line"></span><br><span class="line">        m_shaderResourceViewLookup.insert(std::make_pair(shaderInputBindDesc.Name, shaderResourceViewProxy));</span><br><span class="line">        m_shaderResourceViews.push_back(shaderResourceViewProxy);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">    case D3D_SIT_SAMPLER:</span><br><span class="line">    &#123;</span><br><span class="line">        auto samplerProxy = std::make_shared&lt;SamplerProxy&gt;();</span><br><span class="line">        samplerProxy-&gt;SlotIndex = shaderInputBindDesc.BindPoint;</span><br><span class="line">        samplerProxy-&gt;Index = static_cast&lt;unsigned int&gt;(m_samplers.size());</span><br><span class="line"></span><br><span class="line">        m_samplerLookup.insert(std::make_pair(shaderInputBindDesc.Name, samplerProxy));</span><br><span class="line">        m_samplers.push_back(samplerProxy);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">    case D3D_SIT_CBUFFER:</span><br><span class="line">    case D3D_SIT_TBUFFER:</span><br><span class="line">    case D3D_SIT_UAV_RWTYPED:</span><br><span class="line">    case D3D_SIT_STRUCTURED:</span><br><span class="line">    case D3D_SIT_UAV_RWSTRUCTURED:</span><br><span class="line">    case D3D_SIT_BYTEADDRESS:</span><br><span class="line">    case D3D_SIT_UAV_RWBYTEADDRESS:</span><br><span class="line">    case D3D_SIT_UAV_APPEND_STRUCTURED:</span><br><span class="line">    case D3D_SIT_UAV_CONSUME_STRUCTURED:</span><br><span class="line">    case D3D_SIT_UAV_RWSTRUCTURED_WITH_COUNTER:</span><br><span class="line">    default:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>
<p>通过这部分的代码可以发现<code>D3D_SIT_TEXTURE</code>、<code>D3D_SIT_SAMPLER</code>等都是统一被当作了输入，这个和UE4中材质实例概念感觉就有点相似了。</p>
<h3 id="Input-Layout"><a href="#Input-Layout" class="headerlink" title="Input Layout"></a>Input Layout</h3><p>这个是Vertex Shader独有的，也是可以从Shader Reflection中取到结构描述的。虽然一般来说，我们写HLSL的时候都会统一输入的顶点数据的结构。但是既然能从shader中获取并自动创建，为什么不偷个懒呢:P。</p>
<div><div class="fold_hider"><div class="close hider_title">解析InputLayout</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> VertexShader::CreateInputLayout(ID3DBlob *in_shaderBufferBlob, ID3D11ShaderReflection * in_shaderReflection)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">auto</span> device = Engine::Get()-&gt;GetRenderer()-&gt;GetDevice();</span><br><span class="line"></span><br><span class="line">      D3D11_SHADER_DESC shaderDesc;</span><br><span class="line">      in_shaderReflection-&gt;GetDesc(&amp;shaderDesc);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;D3D11_INPUT_ELEMENT_DESC&gt; inputElementDescs;</span><br><span class="line">      <span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; shaderDesc.InputParameters; i++)</span><br><span class="line">      &#123;</span><br><span class="line">          D3D11_SIGNATURE_PARAMETER_DESC signatureParameterDesc;</span><br><span class="line">          in_shaderReflection-&gt;GetInputParameterDesc(i, &amp;signatureParameterDesc);</span><br><span class="line"></span><br><span class="line">          D3D11_INPUT_ELEMENT_DESC inputElementDesc;</span><br><span class="line">          inputElementDesc.SemanticName = signatureParameterDesc.SemanticName;</span><br><span class="line">          inputElementDesc.SemanticIndex = signatureParameterDesc.SemanticIndex;</span><br><span class="line">          inputElementDesc.InputSlot = <span class="number">0</span>;</span><br><span class="line">          inputElementDesc.AlignedByteOffset = D3D11_APPEND_ALIGNED_ELEMENT;</span><br><span class="line">          inputElementDesc.InputSlotClass = D3D11_INPUT_PER_VERTEX_DATA;</span><br><span class="line">          inputElementDesc.InstanceDataStepRate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (signatureParameterDesc.Mask == <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_UINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32_UINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_SINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32_SINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_FLOAT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32_FLOAT;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.Mask &lt;= <span class="number">3</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_UINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32_UINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_SINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32_SINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_FLOAT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32_FLOAT;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.Mask &lt;= <span class="number">7</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_UINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32_UINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_SINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32_SINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_FLOAT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32_FLOAT;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.Mask &lt;= <span class="number">15</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_UINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32A32_UINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_SINT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32A32_SINT;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (signatureParameterDesc.ComponentType == D3D_REGISTER_COMPONENT_FLOAT32)</span><br><span class="line">              &#123;</span><br><span class="line">                  inputElementDesc.Format = DXGI_FORMAT_R32G32B32A32_FLOAT;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          inputElementDescs.push_back(inputElementDesc);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RE_D3D_ThrowIfFailed(</span><br><span class="line">          device-&gt;CreateInputLayout(</span><br><span class="line">              inputElementDescs.data(),</span><br><span class="line">              <span class="keyword">static_cast</span>&lt;UINT&gt;(inputElementDescs.size()),</span><br><span class="line">              in_shaderBufferBlob-&gt;GetBufferPointer(),</span><br><span class="line">              in_shaderBufferBlob-&gt;GetBufferSize(),</span><br><span class="line">              m_inputLayout.ReleaseAndGetAddressOf()</span><br><span class="line">          )</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</div></div>
<p>这部分代码就更长了，因为它涉及到大量的掩码检测和类型判断。不管是手写Input Layout还是从shader中自动获取，我都需要注意的是输入的顶点数据要和其保持一致。而在DirectX 12中就更加严格了，包括C++声明的Root Constants也都需要保证一致。</p>
<h2 id="“Effect”框架结构"><a href="#“Effect”框架结构" class="headerlink" title="“Effect”框架结构"></a>“Effect”框架结构</h2><p>好了上面代码基本上说明了怎么从Shader Reflection中获取我们想要的数据信息。我们接下来要做的就是如何去存储这些个数据以及怎么使用它们。我用了BaseShader、BasePass、BaseEffect来组成我们的框架。</p>
<h3 id="BaseShader"><a href="#BaseShader" class="headerlink" title="BaseShader"></a>BaseShader</h3><div><div class="fold_hider"><div class="close hider_title">类定义</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseShader</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        BaseShader() = <span class="keyword">default</span>;</span><br><span class="line">        <span class="keyword">virtual</span> ~BaseShader() = <span class="keyword">default</span>;</span><br><span class="line">        BaseShader(<span class="keyword">const</span> BaseShader &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BaseShader(BaseShader &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BaseShader &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> BaseShader&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// 第一部分----------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">LoadCompiledShader</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::wstring &amp;in_filepath)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CompileShaderFromFile</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::wstring &amp;in_filepath, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_entryName)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateShaderFromBlob</span><span class="params">(ID3DBlob *in_blob)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 第一部分----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第二部分----------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Bind</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">UploadAllConstantBufferData</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">UploadConstantBufferData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> in_index)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">UploadConstantBufferData</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_bufferName)</span></span>;</span><br><span class="line">        <span class="comment">// 第二部分----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第三部分----------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetData</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">const</span> <span class="keyword">void</span>* in_data, <span class="keyword">unsigned</span> <span class="keyword">int</span> in_sizeInBytes)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetInt</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">int</span> in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetFloat</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">float</span> in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetFloat2</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">const</span> XMFLOAT2 in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetFloat3</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">const</span> XMFLOAT3 in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetFloat4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">const</span> XMFLOAT4 in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">SetFloat4x4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="keyword">const</span> XMFLOAT4X4 in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> XM_CALLCONV <span class="title">SetVector3</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, FXMVECTOR in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> XM_CALLCONV <span class="title">SetVector4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, FXMVECTOR in_value)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> XM_CALLCONV <span class="title">SetMatrix4x4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, FXMMATRIX in_value)</span></span>;</span><br><span class="line">        <span class="comment">// 第三部分----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="comment">// 第四部分----------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">HandleShaderRefelction</span><span class="params">(ID3D11ShaderReflection *in_shaderReflection)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OutputCompilingShaderErrorMessage</span><span class="params">(ID3DBlob* in_errorblob, <span class="keyword">const</span> <span class="built_in">std</span>::wstring &amp;in_filepath)</span></span>;</span><br><span class="line">        <span class="comment">// 第四部分----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第五部分----------------------------------------------------------------------------------------</span></span><br><span class="line">        <span class="function"><span class="keyword">const</span> VariableProxy *<span class="title">GetVariableProxy</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> VariableProxy *<span class="title">GetVariableProxy</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, <span class="built_in">std</span>::<span class="keyword">size_t</span> in_sizeInBytes)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">const</span> ConstantBufferProxy *<span class="title">GetConstantBufferProxy</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> ConstantBufferProxy *<span class="title">GetConstantBufferProxy</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> in_index)</span></span>;</span><br><span class="line">        <span class="keyword">inline</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> GetNumConstantBuffers() <span class="keyword">const</span> &#123; <span class="keyword">return</span> m_numConstantBuffers; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">const</span> ShaderResourceViewProxy *<span class="title">GetShaderResourceViewProxy</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> ShaderResourceViewProxy *<span class="title">GetShaderResourceViewProxy</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> in_index)</span></span>;</span><br><span class="line">        <span class="keyword">inline</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> GetNumShaderResourceViews() <span class="keyword">const</span> &#123; <span class="keyword">return</span> m_shaderResourceViews.size(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SetShaderResourceView</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, ID3D11ShaderResourceView *in_shaderResourceView)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">const</span> SamplerProxy *<span class="title">GetSamplerProxy</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> SamplerProxy *<span class="title">GetSamplerProxy</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> in_index)</span></span>;</span><br><span class="line">        <span class="keyword">inline</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> GetNumSamplers() <span class="keyword">const</span> &#123; <span class="keyword">return</span> m_samplers.size(); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SetSampler</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;in_name, ID3D11SamplerState* in_sampler)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 第五部分----------------------------------------------------------------------------------------</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="keyword">size_t</span> m_numConstantBuffers;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ConstantBufferProxy&gt;&gt; m_constantBuffers;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ShaderResourceViewProxy&gt;&gt; m_shaderResourceViews;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;SamplerProxy&gt;&gt; m_samplers;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ConstantBufferProxy&gt;&gt; m_constantBufferLookup;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt; VariableProxy&gt;&gt; m_variableLookup;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;ShaderResourceViewProxy&gt;&gt; m_shaderResourceViewLookup;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;SamplerProxy&gt;&gt; m_samplerLookup;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

</div></div>
<p>类的定义就是这样，虽然很长我们分四个部分来看就好了。我在代码中用分割线标注了，当然我自己的源代码中没有这样的线:p。</p>
<ul>
<li>第一部分就是从文件中编译或者加载出shader的字节码。</li>
<li>第二部分就是在运行过程中，我们将shader绑定到管线，或者更新Constant Buffer数据是需要的方法。</li>
<li>第三部分就是正如开头介绍使用方式时说的传递Constant Buffer的方法，基本上适配的所有类型。因为不管怎么样我还是有SetData来通吃所有类型:p。</li>
<li>第四部分就是具体处理Shader Reflection来填充诸如m_constantBufferLookup的数据结构的方法。</li>
<li>第五部分提供类内部的快速查找变量的方法，不考虑字符串创建的消耗的话，都是常量时间的读取消耗。因为这个部分会被外部通过第三部分频繁访问。</li>
</ul>
<h3 id="BasePass"><a href="#BasePass" class="headerlink" title="BasePass"></a>BasePass</h3><div><div class="fold_hider"><div class="close hider_title">BasePass.h</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __BASE_PASS_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __BASE_PASS_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"EngineHeader.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Shaders.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> RE</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RenderObject</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BasePass</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        BasePass() = <span class="keyword">default</span>;</span><br><span class="line">        ~BasePass() = <span class="keyword">default</span>;</span><br><span class="line">        BasePass(<span class="keyword">const</span> BasePass &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BasePass(BasePass &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BasePass&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> BasePass &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Render</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RenderObject&gt;&gt; &amp;in_renderObjects)</span> </span>&#123;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RenderAsPostProcess</span><span class="params">(ID3D11ShaderResourceView **in_shaderResourceViews, UINT in_numShaderResourceViews)</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginPass</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ApplyPass</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">EndPass</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;VertexShader&gt; m_vertexShader;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PixelShader&gt; m_pixelShader;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !__BASE_PASS_H__</span></span></span><br></pre></td></tr></table></figure>

</div></div>
<p>什么是pass呢，我最近在看知乎上的这个问题：<a href="https://www.zhihu.com/question/305707508/answer/632552118" target="_blank" rel="noopener">计算机图形里面的RenderingPass（渲染通道）是什么意思？</a>。里面有不少干货呢！而我暂时理解的pass其实和上面的类结构差不多（暂时只放了VS和PS）。</p>
<h3 id="BaseEffect"><a href="#BaseEffect" class="headerlink" title="BaseEffect"></a>BaseEffect</h3><div><div class="fold_hider"><div class="close hider_title">BaseEffect.h</div></div><div class="fold">
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __BASE_EFFECT_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __BASE_EFFECT_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"EngineHeader.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"BasePass.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"RenderTarget.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> RE</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BaseEffect</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        BaseEffect() = <span class="keyword">default</span>;</span><br><span class="line">        <span class="keyword">virtual</span> ~BaseEffect() = <span class="keyword">default</span>;</span><br><span class="line">        BaseEffect(<span class="keyword">const</span> BaseEffect &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BaseEffect(BaseEffect &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">        BaseEffect&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> BaseEffect &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Render</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RenderObject&gt;&gt; &amp;in_renderObjects)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RenderFinalRenderTarget</span><span class="params">(ID3D11ShaderResourceView * in_shaderResourceView)</span></span>;</span><br><span class="line">        <span class="function">ID3D11ShaderResourceView *<span class="title">GetFinalRenderTargetShaderResourceView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RenderTarget&gt; m_finalRenderTarget;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !__BASE_EFFECT_H__</span></span></span><br></pre></td></tr></table></figure>

</div></div>
<p>想了半天还是觉的叫Effect好些，因为我这里的设计还是不是很靠近FX里面的Technique的。因为我把Effect最终渲染结果和中间结果都放在了各自的RenderTarget中。即是往一个全屏quad上渲染一张贴图。这么做的好处是我可以写出如下的代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* items[] = &#123; <span class="string">"Basic"</span>, <span class="string">"Shadow Map"</span>, <span class="string">"PBR"</span> &#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> item_current = <span class="number">2</span>;</span><br><span class="line">    ImGui::Combo(<span class="string">"Effect"</span>, &amp;item_current, items, IM_ARRAYSIZE(items));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (item_current == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_basicEffect-&gt;Render(m_renderObjects);</span><br><span class="line">        RenderFinal(m_basicEffect-&gt;GetFinalRenderTargetShaderResourceView());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (item_current == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_shadowMapEffect-&gt;Render(m_renderObjects);</span><br><span class="line">        RenderFinal(m_shadowMapEffect-&gt;GetFinalRenderTargetShaderResourceView());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (item_current == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_PBRBasicEffect-&gt;Render(m_renderObjects);</span><br><span class="line">        RenderFinal(m_PBRBasicEffect-&gt;GetFinalRenderTargetShaderResourceView());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然Effect可以有多个Pass比如在Shadow Map Effect中：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ShadowMapEffect::Render(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RenderObject&gt;&gt;&amp; in_renderObjects)</span><br><span class="line">&#123;</span><br><span class="line">    m_depthRenderTarget-&gt;BindDSVOnly();</span><br><span class="line">    m_lightViewDepthPass-&gt;Render(in_renderObjects);</span><br><span class="line"></span><br><span class="line">    ImGui::Begin(<span class="string">"Light View Depth"</span>);</span><br><span class="line">    ImGui::Image(m_depthRenderTarget-&gt;GetShaderResourceViewDS(), ImVec2(<span class="number">512.0f</span>, <span class="number">512.0f</span>));</span><br><span class="line">    ImGui::End();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    m_shadowMappingRenderTarget-&gt;BindRTVAndDSV();</span><br><span class="line">    m_shadowMappingPass-&gt;Render(in_renderObjects, m_depthRenderTarget-&gt;GetShaderResourceViewDS());</span><br><span class="line"></span><br><span class="line">    RenderFinalRenderTarget(m_shadowMappingRenderTarget-&gt;GetShaderResourceViewRT(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以很轻松地在各个渲染效果中切换，如下图。</p>
<p><img src="/2019/03/26/使用Shader-Reflection搭建简单的Effect框架/Snipaste_2019-03-26_13-37-33.png" alt></p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>当前还只是初步的搭建了框架，不过基本的思路已经清晰了，还需要继续完善。接下来把以前抄过的教程代码来慢慢写到新框架来把。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Shader/" rel="tag"># Shader</a>
          
            <a href="/tags/HLSL/" rel="tag"># HLSL</a>
          
            <a href="/tags/C/" rel="tag"># C++</a>
          
            <a href="/tags/Rendering/" rel="tag"># Rendering</a>
          
            <a href="/tags/Effect/" rel="tag"># Effect</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/01/使用Motion-Builder替代UE4的Animation-Retargeting/" rel="next" title="使用Motion Builder替代UE4的Animation Retargeting">
                <i class="fa fa-chevron-left"></i> 使用Motion Builder替代UE4的Animation Retargeting
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Daftar Isi
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Ikhtisar
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ArcEcho</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">posting</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">kategori</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Shader-Reflection"><span class="nav-number">1.</span> <span class="nav-text">Shader Reflection</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">1.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用说明"><span class="nav-number">1.2.</span> <span class="nav-text">使用说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Shader-Reflection-对象"><span class="nav-number">1.2.1.</span> <span class="nav-text">创建Shader Reflection 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用示例"><span class="nav-number">1.2.2.</span> <span class="nav-text">使用示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#学习动机"><span class="nav-number">1.3.</span> <span class="nav-text">学习动机</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自制“Effect”框架"><span class="nav-number">2.</span> <span class="nav-text">自制“Effect”框架</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用的几个类型"><span class="nav-number">2.1.</span> <span class="nav-text">常用的几个类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Variable"><span class="nav-number">2.1.1.</span> <span class="nav-text">Variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Constant-Buffer"><span class="nav-number">2.1.2.</span> <span class="nav-text">Constant Buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shader-Resource-View-和-Sampler"><span class="nav-number">2.1.3.</span> <span class="nav-text">Shader Resource View 和 Sampler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Input-Layout"><span class="nav-number">2.1.4.</span> <span class="nav-text">Input Layout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“Effect”框架结构"><span class="nav-number">2.2.</span> <span class="nav-text">“Effect”框架结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BaseShader"><span class="nav-number">2.2.1.</span> <span class="nav-text">BaseShader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BasePass"><span class="nav-number">2.2.2.</span> <span class="nav-text">BasePass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BaseEffect"><span class="nav-number">2.2.3.</span> <span class="nav-text">BaseEffect</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结语"><span class="nav-number">3.</span> <span class="nav-text">结语</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ArcEcho</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Tema – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
